<?php
// Safety check
$CLEAN_MODE_ON = false;
$WORM_SIGNATURE = "@include";
//$WORM_SIGNATURE = "String.fromCharCode(";

echo "<div>Please do take backup</div>";
echo "<div>Listing infected files.</div>";



$di = new RecursiveDirectoryIterator(getcwd(),RecursiveDirectoryIterator::SKIP_DOTS);
//$files = new RecursiveIteratorIterator($dir);


//$di = new RecursiveDirectoryIterator('../',RecursiveDirectoryIterator::SKIP_DOTS);
/*
$di = new RecursiveDirectoryIterator(__DIR__,RecursiveDirectoryIterator::SKIP_DOTS);
*/

$di = new RecursiveDirectoryIterator(__DIR__,RecursiveDirectoryIterator::SKIP_DOTS);
$it = new RecursiveIteratorIterator($di);
foreach($it as $file) {

    if (pathinfo($file, PATHINFO_EXTENSION) == "php" && pathinfo($file, PATHINFO_BASENAME) != basename(__FILE__) ) {
       // echo "Scanning " . $file ."<br/>";
		$fileContents = file_get_contents($file, FILE_USE_INCLUDE_PATH);
		
		/*
		if (preg_match('/<\?php.+?\?>/ms', $fileContents, $matches, PREG_OFFSET_CAPTURE)){
		    */
			// Check for the first match only - assume worm's php code block is the first one in the file.
		//	$firstElem = $matches[0][0];
			$firstElem = $fileContents;
	//	echo preg_match("/$WORM_SIGNATURE/", $firstElem);
			if(strpos($firstElem, $WORM_SIGNATURE) > 1){
			   
				echo "<div><a href='scanedit.php?path=" . $file . "' target='about:blank'>" . $file . "</a> " . htmlentities(substr($firstElem, 0, 50) . " ........... " . substr($firstElem, strlen($firstElem)-50, strlen($firstElem))) . "</div>", PHP_EOL;
				
				if($CLEAN_MODE_ON){
				//	echo "<div>Cleaning the file...</div>";
					$cleanedFileContents = str_replace($firstElem, '', $fileContents);
				//	file_put_contents($file, $cleanedFileContents);
				//	echo "<div>File found!</div>";
				}
			}
		/*} */
    }
}
echo "<div>Done. Exiting...</div>";
?>